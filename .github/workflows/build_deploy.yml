name: Deploy sample app

on:
  push:
    branches:
     - main


jobs:

  deploy:
    name: Build image
    runs-on: ubuntu-latest

    steps:
    - name: Check out code
      uses: actions/checkout@v2

    - name: Check out code
      uses: actions/checkout@v2
      with:
        path: ./hello-task

    - name: Install kubectl
      uses: azure/setup-kubectl@v1
      with:
        version: 'v1.21.3'
      id: install


    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username:  ${{ secrets.DOCKERHUB_USERNAME }}
        password:  ${{ secrets.DOCKERHUB_TOKEN }}



    - name: Build, tag, and push image to container registry
      run: |
        docker build -t php -t mustafaeid/test:test .
        docker tag php mustafaeid/test:test
        docker push mustafaeid/test:test

#    - name: Start minikube
#      uses: medyagh/setup-minikube@master
    -  uses: azure/k8s-set-context@v2
       with:
         method: kubeconfig
         kubeconfig: ${{ secrets.KUBE_CONFIG }}
         context: minikube

#   - uses: azure/k8s-set-context@v2
#     with:
#       method: kubeconfig
#       kubeconfig: ${{ secrets.KUBE_CONFIG }}
#       context: minikube

    - name: Deploy to kubernetes
      run: |
        kubectl apply -f deployment.yaml
#        kubectl apply -f eks/deployment.yaml
#        kubectl apply -f eks/service.yaml
#        kubectl apply -f eks/issuer.yaml
#        kubectl apply -f eks/ingress.yaml

#    - name: Test service URLs
#      run: |
#        minikube service list
#        minikube service hello --url
#        echo "------------------opening the service------------------"
